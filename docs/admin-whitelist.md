# 后台访问IP白名单使用指南

## 功能概述

后台访问IP白名单功能限制只有指定IP地址可以访问Typecho后台管理界面，为您的网站提供额外的安全保护层。

## 核心特性

- **多种IP格式支持**：单个IP、CIDR、通配符、IP范围
- **安全默认行为**：未配置时允许所有IP访问，避免锁定
- **灵活配置**：支持注释、0.0.0.0特殊值
- **自动拦截**：非白名单IP自动清除登录凭证并重定向
- **无性能影响**：仅在后台访问时检查，不影响前台

## 快速开始

### 1. 获取当前IP

在配置前，先确认您的当前IP地址：

**方法一：** 访问 https://ip.sb 或 https://ifconfig.me

**方法二：** 在服务器上运行：
```bash
curl ifconfig.me
```

**方法三：** 查看插件控制台的访客日志

### 2. 配置白名单

1. 登录Typecho后台
2. 进入"控制台" → "插件管理" → "BlockIPForTypecho" → "设置"
3. 找到"后台访问IP白名单"配置项
4. 输入您的IP地址（每行一个）
5. 保存配置

### 3. 测试配置

**重要：** 配置后不要立即退出登录！

1. 在新的浏览器隐身窗口中访问后台
2. 确认可以正常访问
3. 如果无法访问，返回原窗口修改配置

## 配置格式

### 单个IP地址
```
192.168.1.100
203.0.113.50
```

### CIDR格式（网段）
```
192.168.1.0/24      # 192.168.1.0 - 192.168.1.255
10.0.0.0/8          # 10.0.0.0 - 10.255.255.255
```

### 通配符格式
```
192.168.1.*         # 192.168.1.0 - 192.168.1.255
10.0.*.*            # 10.0.0.0 - 10.0.255.255
```

### IP范围
```
192.168.1.1-50      # 192.168.1.1 - 192.168.1.50
203.0.113.1-100     # 203.0.113.1 - 203.0.113.100
```

### 添加注释
```
192.168.1.100       # 办公室IP
192.168.1.0/24      # 办公室网段
10.0.0.1            # VPN出口IP
```

### 特殊值
```
0.0.0.0             # 允许所有IP（等同于不配置）
```

## 配置示例

### 示例1：单一办公室IP
```
203.0.113.100       # 办公室固定IP
```

### 示例2：办公室网段
```
192.168.1.0/24      # 办公室内网
203.0.113.100       # 办公室外网IP
```

### 示例3：多个位置
```
# 办公室
192.168.1.0/24
203.0.113.100

# 家庭
198.51.100.50

# VPN
10.0.0.0/8
```

### 示例4：动态IP场景
```
# 使用较大的IP段
203.0.113.0/24      # ISP分配的IP段
```

## 重定向配置

### 配置重定向URL

当非白名单IP尝试访问后台时，可以重定向到指定URL。

**配置位置：** "非白名单IP重定向URL"

**示例：**
```
https://example.com
https://example.com/403.html
https://example.com/access-denied
```

**留空：** 默认重定向到网站首页

## 常见场景

### 场景1：固定IP办公室
```
203.0.113.100       # 办公室IP
```

### 场景2：动态IP家庭网络
```
# 方案A：使用ISP的IP段
203.0.113.0/24

# 方案B：使用DDNS + 定期更新
203.0.113.100       # 当前IP，需定期更新
```

### 场景3：多人团队
```
203.0.113.100       # 管理员A
203.0.113.101       # 管理员B
192.168.1.0/24      # 办公室网段
10.0.0.0/8          # VPN网段
```

### 场景4：云服务器管理
```
# 跳板机IP
198.51.100.10

# 办公室IP
203.0.113.0/24
```

### 场景5：临时访问
```
# 长期IP
203.0.113.100

# 临时IP（出差、远程等）
198.51.100.50       # 临时添加，用完删除
```

## 安全建议

### 1. 配置前准备
- ✓ 确认当前IP地址
- ✓ 准备备用访问方式（SSH、FTP）
- ✓ 备份数据库
- ✓ 在测试环境先测试

### 2. 配置时注意
- ✓ 不要立即退出登录
- ✓ 使用新窗口测试
- ✓ 保持原窗口打开
- ✓ 确认配置生效后再关闭

### 3. 日常维护
- ✓ 定期检查白名单
- ✓ 删除过期IP
- ✓ 更新动态IP
- ✓ 记录配置变更

### 4. 应急措施
- ✓ 准备SSH访问
- ✓ 准备FTP访问
- ✓ 准备数据库访问
- ✓ 了解恢复步骤

## 故障排查

### 问题1：配置后无法访问后台

**原因：** 当前IP不在白名单中

**解决方案：**

**方法一：通过SSH/FTP修改配置**
1. 连接到服务器
2. 编辑数据库中的配置
3. 清空adminWhitelist字段

**方法二：通过数据库修改**
```sql
UPDATE typecho_options 
SET value = REPLACE(value, '"adminWhitelist";s:', '"adminWhitelist";s:0:"') 
WHERE name = 'plugin:BlockIPForTypecho';
```

**方法三：禁用插件**
```sql
UPDATE typecho_options 
SET value = 'a:0:{}' 
WHERE name = 'plugins';
```

### 问题2：动态IP频繁变化

**解决方案：**

**方案一：使用IP段**
```
203.0.113.0/24      # 使用整个C段
```

**方案二：使用DDNS**
1. 配置DDNS服务
2. 定期更新白名单
3. 使用脚本自动更新

**方案三：使用VPN**
```
10.0.0.0/8          # VPN网段
```

### 问题3：团队成员无法访问

**原因：** 成员IP未添加到白名单

**解决方案：**
1. 获取成员IP地址
2. 添加到白名单
3. 通知成员测试

### 问题4：配置后前台也无法访问

**原因：** 配置错误或与其他功能冲突

**解决方案：**
1. 检查是否误配置了前台白名单
2. 检查工作模式是否为白名单模式
3. 查看错误日志

## 高级用法

### 1. 结合VPN使用
```
# 仅允许VPN IP访问
10.0.0.0/8          # VPN网段
```

### 2. 结合跳板机使用
```
# 仅允许跳板机IP
198.51.100.10       # 跳板机IP
```

### 3. 分时段访问
通过脚本定期更新白名单，实现分时段访问控制。

### 4. 多层防护
```
# 后台白名单
后台访问IP白名单：192.168.1.0/24

# 全局白名单
IP白名单：192.168.1.0/24

# 双重保护
```

## 性能影响

- **前台访问**：无影响（不执行检查）
- **后台访问**：约1-2ms额外开销
- **内存占用**：可忽略不计
- **数据库查询**：0（使用现有配置）

## 与其他功能的关系

### 与IP白名单的区别
- **IP白名单**：全局白名单，前后台都生效
- **后台访问白名单**：仅后台生效，更精确的控制

### 与工作模式的关系
- **黑名单模式**：后台白名单独立生效
- **白名单模式**：后台白名单优先级更高
- **智能模式**：后台白名单独立生效

### 执行顺序
1. 后台访问白名单检查（仅后台）
2. 全局IP白名单检查
3. 其他安全检查

## 最佳实践

### 1. 初次配置
```
# 第一步：添加当前IP
203.0.113.100

# 第二步：测试访问
# 在新窗口测试

# 第三步：添加其他IP
# 确认第一步成功后再添加
```

### 2. 生产环境
```
# 使用固定IP或IP段
203.0.113.0/24      # 办公室
10.0.0.0/8          # VPN

# 配置重定向
重定向URL：https://example.com
```

### 3. 开发环境
```
# 可以不配置或使用宽松规则
0.0.0.0             # 允许所有IP
```

### 4. 应急访问
```
# 保留应急访问IP
198.51.100.10       # 应急跳板机
```

## 下一步

配置完成后，建议查看：
- [安全最佳实践](./security-best-practices.md)
- [故障排查](./troubleshooting.md)
- [配置指南](./configuration.md)
