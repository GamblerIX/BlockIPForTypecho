# 安全最佳实践

## 基础安全配置

### 1. 启用后台访问白名单
```
后台访问IP白名单：
203.0.113.100       # 您的IP
192.168.1.0/24      # 办公室网段
```

**重要性：** ⭐⭐⭐⭐⭐
**影响：** 防止未授权访问后台

### 2. 启用登录验证码
```
☑ 启用登录验证码保护
```

**重要性：** ⭐⭐⭐⭐⭐
**影响：** 防止暴力破解

### 3. 启用所有安全防护
```
☑ 启用SQL注入防护
☑ 启用XSS攻击防护
☑ 启用CSRF攻击防护
```

**重要性：** ⭐⭐⭐⭐⭐
**影响：** 防止常见Web攻击

### 4. 配置访问频率限制
```
访问间隔：10秒
```

**重要性：** ⭐⭐⭐⭐
**影响：** 防止DDoS和爬虫

### 5. 使用智能模式
```
工作模式：智能模式
```

**重要性：** ⭐⭐⭐⭐
**影响：** 自动识别和拦截威胁

## IP管理最佳实践

### 白名单管理

#### 1. 最小权限原则
只添加必需的IP到白名单：
```
# 好的做法
203.0.113.100       # 管理员IP

# 不好的做法
0.0.0.0/0           # 允许所有IP
```

#### 2. 定期审查
- 每月检查一次白名单
- 删除不再使用的IP
- 更新动态IP

#### 3. 使用注释
```
203.0.113.100       # 张三 - 添加于2024-01-01
203.0.113.101       # 李四 - 添加于2024-01-15
```

### 黑名单管理

#### 1. 及时添加恶意IP
发现攻击时立即添加到黑名单：
```
198.51.100.10       # 攻击IP - 2024-01-01
```

#### 2. 使用IP段
对于批量攻击：
```
198.51.100.0/24     # 攻击来源网段
```

#### 3. 定期清理
- 每季度检查一次黑名单
- 删除过期的临时封禁
- 保留长期威胁IP

## 后台安全

### 1. 限制后台访问
```
后台访问IP白名单：
203.0.113.100       # 仅允许特定IP
```

### 2. 强密码策略
- 使用16位以上密码
- 包含大小写字母、数字、特殊字符
- 定期更换密码
- 不使用常见密码

### 3. 双因素认证
结合其他插件实现2FA：
- Google Authenticator
- 短信验证码
- 邮箱验证码

### 4. 限制登录尝试
```
访问间隔：10秒
☑ 启用登录验证码保护
```

### 5. 修改后台路径
在config.inc.php中修改：
```php
define('__TYPECHO_ADMIN_DIR__', '/your-custom-admin/');
```

## 数据安全

### 1. 定期备份
- 每天备份数据库
- 每周备份文件
- 异地存储备份

### 2. 启用访客日志
```
☑ 启用访客日志记录
日志保留天数：30
```

### 3. 监控异常访问
定期检查：
- 安全日志
- 访客日志
- 拦截记录

### 4. 数据加密
- 使用HTTPS
- 加密敏感数据
- 安全存储密钥

## 服务器安全

### 1. 系统更新
- 及时更新操作系统
- 更新PHP版本
- 更新数据库

### 2. 防火墙配置
```bash
# 仅开放必要端口
ufw allow 80/tcp
ufw allow 443/tcp
ufw allow 22/tcp
ufw enable
```

### 3. SSH安全
```bash
# 禁用root登录
PermitRootLogin no

# 使用密钥认证
PasswordAuthentication no

# 修改默认端口
Port 2222
```

### 4. 文件权限
```bash
# 设置正确的权限
chmod 755 /path/to/typecho
chmod 644 /path/to/typecho/config.inc.php
```

## 应用安全

### 1. 隐藏版本信息
在config.inc.php中：
```php
define('__TYPECHO_DEBUG__', false);
```

### 2. 禁用危险函数
在php.ini中：
```ini
disable_functions = exec,passthru,shell_exec,system
```

### 3. 限制文件上传
```
# 限制上传类型
允许的文件类型：jpg,png,gif,pdf

# 限制文件大小
最大上传大小：2MB
```

### 4. 使用CDN
- 隐藏真实IP
- 防御DDoS攻击
- 加速访问

## 监控和响应

### 1. 实时监控
- 监控CPU使用率
- 监控内存使用
- 监控磁盘空间
- 监控网络流量

### 2. 日志分析
定期分析：
- 访问日志
- 错误日志
- 安全日志

### 3. 告警设置
配置告警：
- 异常访问告警
- 攻击尝试告警
- 系统资源告警

### 4. 应急响应
准备应急预案：
- 攻击应对流程
- 数据恢复流程
- 联系方式列表

## 配置模板

### 高安全配置
```
工作模式：白名单模式
IP白名单：203.0.113.100
后台访问IP白名单：203.0.113.100
☑ 启用SQL注入防护
☑ 启用XSS攻击防护
☑ 启用CSRF攻击防护
☑ 启用登录验证码保护
☑ 启用访客日志记录
访问间隔：5秒
日志保留天数：90
调试模式：关闭
```

### 平衡配置（推荐）
```
工作模式：智能模式
后台访问IP白名单：203.0.113.0/24
☑ 启用SQL注入防护
☑ 启用XSS攻击防护
☑ 启用CSRF攻击防护
☑ 启用登录验证码保护
☑ 启用访客日志记录
访问间隔：10秒
日志保留天数：30
调试模式：关闭
```

### 性能优先配置
```
工作模式：黑名单模式
☑ 启用SQL注入防护
☑ 启用XSS攻击防护
访问间隔：15秒
□ 禁用访客日志记录
调试模式：关闭
```

## 安全检查清单

### 每日检查
- [ ] 查看安全日志
- [ ] 检查异常访问
- [ ] 确认备份完成

### 每周检查
- [ ] 分析访客日志
- [ ] 检查黑名单
- [ ] 更新系统补丁

### 每月检查
- [ ] 审查白名单
- [ ] 清理过期日志
- [ ] 测试恢复流程
- [ ] 更新密码

### 每季度检查
- [ ] 全面安全审计
- [ ] 更新安全策略
- [ ] 培训团队成员
- [ ] 测试应急预案

## 常见安全威胁

### 1. 暴力破解
**防护措施：**
- 启用登录验证码
- 限制登录尝试
- 使用强密码
- 启用后台白名单

### 2. SQL注入
**防护措施：**
- 启用SQL注入防护
- 使用参数化查询
- 过滤用户输入
- 定期更新

### 3. XSS攻击
**防护措施：**
- 启用XSS防护
- 过滤输出内容
- 使用CSP策略
- 验证用户输入

### 4. CSRF攻击
**防护措施：**
- 启用CSRF防护
- 使用Token验证
- 检查Referer
- 验证请求来源

### 5. DDoS攻击
**防护措施：**
- 使用CDN
- 限制访问频率
- 配置防火墙
- 使用DDoS防护服务

## 应急处理

### 发现攻击时
1. 立即添加攻击IP到黑名单
2. 检查日志确认攻击类型
3. 评估损失
4. 修复漏洞
5. 恢复数据（如需要）

### 被入侵后
1. 立即断开网络
2. 保留证据
3. 分析入侵路径
4. 修复漏洞
5. 恢复系统
6. 加强防护

### 数据泄露后
1. 评估泄露范围
2. 通知受影响用户
3. 修复漏洞
4. 加强加密
5. 更新安全策略

## 合规建议

### GDPR合规
- 记录数据处理活动
- 提供数据导出功能
- 实现数据删除功能
- 加密敏感数据

### 等保合规
- 实施访问控制
- 记录安全日志
- 定期安全审计
- 应急响应机制

## 参考资源

### 官方文档
- Typecho官方文档
- PHP安全指南
- OWASP安全指南

### 安全工具
- Nmap - 端口扫描
- Wireshark - 流量分析
- Fail2ban - 入侵防护

### 学习资源
- OWASP Top 10
- CWE/SANS Top 25
- 安全编码规范

## 下一步

实施安全措施后，建议：
- [故障排查](./troubleshooting.md) - 解决常见问题
- [配置指南](./configuration.md) - 优化配置
- [后台白名单使用指南](./admin-whitelist.md) - 详细配置
